<div class="search-container">
  <div class="search-input-wrapper">
    <span class="cmd">></span>
    <input
      type="text"
      id="search-input"
      placeholder="grep --fuzzy 'incident'..."
      autocomplete="off"
    />
    <kbd class="search-kbd">/</kbd>
  </div>
  <div id="results-container" class="search-results"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
  let fuse;
  const searchInput = document.getElementById("search-input");
  const resultsContainer = document.getElementById("results-container");

  fetch("{{ '/assets/json/search-data.json' | relative_url }}")
    .then((response) => response.json())
    .then((data) => {
      fuse = new Fuse(data, {
        keys: [
          { name: "title", weight: 0.7 },
          { name: "tags", weight: 0.5 },
          { name: "content", weight: 0.2 },
        ],
        threshold: 0.3,
        includeMatches: true,
      });
    });

  searchInput.addEventListener("input", (e) => {
    const query = e.target.value;
    if (query.length < 2) {
      resultsContainer.style.display = "none";
      return;
    }

    const results = fuse.search(query);
    displayResults(results);
  });

  function displayResults(results) {
    if (results.length === 0) {
      resultsContainer.innerHTML =
        '<div class="result-item" style="color: var(--status-critical);">[!] No matching records found.</div>';
    } else {
      const limitedResults = results.slice(0, 5);

      resultsContainer.innerHTML = limitedResults
        .map(
          (res) => `
            <div class="result-item">
                <a href="${res.item.url}">
                    <span class="res-category">${res.item.collection}</span>
                    <span class="res-title">${res.item.title}</span>
                    <span class="res-snippet">${res.item.content}...</span>
                </a>
            </div>
        `,
        )
        .join("");
    }
    resultsContainer.style.display = "block";
  }

  // Fecha ao clicar fora
  document.addEventListener("click", (e) => {
    if (!document.querySelector(".search-container").contains(e.target)) {
      resultsContainer.style.display = "none";
    }
  });

  document.addEventListener("keydown", (e) => {
    if (
      e.key === "/" &&
      document.activeElement.tagName !== "INPUT" &&
      document.activeElement.tagName !== "TEXTAREA"
    ) {
      e.preventDefault();
      searchInput.focus();
    }
    if (e.key === "Escape") {
      resultsContainer.style.display = "none";
      searchInput.blur();
    }
  });
</script>
